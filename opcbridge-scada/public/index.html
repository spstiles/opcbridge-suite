<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>opcbridge SCADA</title>
  <link rel="icon" href="data:," />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header class="topbar">
    <div class="brand">opcbridge SCADA</div>
    <div class="status" id="statusLine">Loading…</div>
    <div class="status" id="buildLine"></div>
    <div class="status" id="authLine"></div>

	    <nav class="tabs" id="tabs">
		      <button data-tab="overview" class="tab is-active">Overview</button>
		      <button data-tab="configure" class="tab">Configure Server</button>
		      <button data-tab="workspace" class="tab">Workspace</button>
		      <button data-tab="logger" class="tab">Data Logger</button>
		      <button data-tab="logs" class="tab">Logs</button>
		      <button data-tab="users" class="tab">Users</button>
		      <div class="tabs-right">
		        <a class="tab tab-link" id="topLinkOpcbridge" href="#" target="_blank" rel="noopener noreferrer">opcbridge</a>
		        <a class="tab tab-link" id="topLinkHmi" href="#" target="_blank" rel="noopener noreferrer">HMI</a>
	      </div>
	    </nav>
  </header>

  <main class="main">
    <section id="tab-overview" class="panel is-active">
      <h2>Overview</h2>
      <div class="grid">
        <div class="card">
          <div class="card-title">opcbridge /health</div>
                    <div id="overviewHealthOverall" class="status">Loading…</div>
          <div class="small" id="overviewHealthMeta"></div>
          <div class="small" id="overviewHealthConnections"></div>
          <details class="details" style="margin-top: 10px;">
            <summary class="small">Raw JSON</summary>
            <pre class="mono" id="healthJson">Loading…</pre>
          </details>
        </div>
        <div class="card">
          <div class="card-title">opcbridge-alarms /alarm/api/status</div>
          <pre class="mono" id="alarmsStatusJson">Loading…</pre>
        </div>
      </div>
    </section>

    <section id="tab-configure" class="panel">
      <h2>Configure Server</h2>
      <div class="hint">SCADA server settings (where to find opcbridge/alarms/HMI, refresh rate). Tokens stay on the SCADA server.</div>

      <div class="card">
        <div class="card-title">Server Settings</div>
        <div class="card-body">
          <div class="form" style="max-width: 720px;">
            <div class="form-row">
              <label>SCADA Listen Host</label>
              <input id="scadaListenHost" type="text" placeholder="0.0.0.0" />
            </div>
            <div class="form-row">
              <label>SCADA Listen Port</label>
              <input id="scadaListenPort" type="number" min="1" max="65535" step="1" />
            </div>
            <div class="form-row">
              <label>Refresh Interval (ms)</label>
              <input id="scadaRefreshMs" type="number" min="250" max="30000" step="250" />
            </div>

            <div class="divider"></div>

            <div class="form-row">
              <label>opcbridge Scheme</label>
              <select id="scadaOpcbridgeScheme">
                <option value="http">http</option>
                <option value="https">https</option>
              </select>
            </div>
            <div class="form-row">
              <label>opcbridge Host</label>
              <input id="scadaOpcbridgeHost" type="text" placeholder="127.0.0.1" />
            </div>
            <div class="form-row">
              <label>opcbridge Port</label>
              <input id="scadaOpcbridgePort" type="number" min="1" max="65535" step="1" />
            </div>

            <div class="divider"></div>

            <div class="form-row">
              <label>alarms Scheme</label>
              <select id="scadaAlarmsScheme">
                <option value="http">http</option>
                <option value="https">https</option>
              </select>
            </div>
            <div class="form-row">
              <label>alarms Host</label>
              <input id="scadaAlarmsHost" type="text" placeholder="127.0.0.1" />
            </div>
            <div class="form-row">
              <label>alarms Port</label>
              <input id="scadaAlarmsPort" type="number" min="1" max="65535" step="1" />
            </div>

            <div class="divider"></div>

            <div class="form-row">
              <label>HMI Scheme</label>
              <select id="scadaHmiScheme">
                <option value="http">http</option>
                <option value="https">https</option>
              </select>
            </div>
            <div class="form-row">
              <label>HMI Host</label>
              <input id="scadaHmiHost" type="text" placeholder="127.0.0.1" />
            </div>
            <div class="form-row">
              <label>HMI Port</label>
              <input id="scadaHmiPort" type="number" min="1" max="65535" step="1" />
            </div>
            <div class="form-row">
              <label></label>
              <div class="row-actions">
                <button class="btn" id="scadaOpenHmiBtn" type="button">Open HMI</button>
              </div>
            </div>

            <div class="form-row">
              <label></label>
              <div class="row-actions">
                <button class="btn" id="scadaSettingsReloadBtn" type="button">Reload</button>
                <button class="btn primary" id="scadaSettingsSaveBtn" type="button">Save</button>
              </div>
            </div>

            <div class="hint mono" id="scadaSettingsStatus"></div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top: 14px;">
        <div class="card-title">opcbridge Service (systemd drop-in)</div>
        <div class="hint">Writes a drop-in override for <code>opcbridge.service</code> to enable/disable endpoints and ports, then restarts the service.</div>
        <div class="card-body">
          <div class="form" style="max-width: 720px;">
            <div class="form-row">
              <label>Binary</label>
              <input id="svcOpcbridgeBin" type="text" placeholder="/opt/opcbridge-suite/bin/opcbridge" />
            </div>
            <div class="form-row">
              <label>Config Dir</label>
              <input id="svcOpcbridgeConfigDir" type="text" placeholder="/etc/opcbridge" />
            </div>

            <div class="divider"></div>

            <div class="form-row">
              <label>Enable</label>
              <div class="row-actions" style="gap: 14px; justify-content: flex-start;">
                <label style="display:flex; align-items:center; gap:6px;"><input id="svcHttpEnabled" type="checkbox" /> HTTP</label>
                <label style="display:flex; align-items:center; gap:6px;"><input id="svcWsEnabled" type="checkbox" /> WebSocket</label>
                <label style="display:flex; align-items:center; gap:6px;"><input id="svcOpcuaEnabled" type="checkbox" /> OPC UA</label>
                <label style="display:flex; align-items:center; gap:6px;"><input id="svcMqttEnabled" type="checkbox" /> MQTT</label>
              </div>
            </div>

            <div class="form-row">
              <label>HTTP Port</label>
              <input id="svcHttpPort" type="number" min="1" max="65535" step="1" />
            </div>
            <div class="form-row">
              <label>WS Port</label>
              <input id="svcWsPort" type="number" min="1" max="65535" step="1" />
            </div>
            <div class="form-row">
              <label>OPC UA Port</label>
              <input id="svcOpcuaPort" type="number" min="1" max="65535" step="1" />
            </div>

            <div class="form-row">
              <label></label>
              <div class="row-actions">
                <button class="btn" id="svcReloadBtn" type="button">Reload</button>
                <button class="btn primary" id="svcApplyBtn" type="button">Apply (write drop-in + restart)</button>
              </div>
            </div>
            <div class="hint mono" id="svcStatus"></div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top: 14px;">
        <div class="card-title">MQTT TLS CA Certificate</div>
        <div class="hint">Uploads a <code>ca.crt</code> file to opcbridge (used for MQTT TLS).</div>
        <div class="card-body">
          <div class="form" style="max-width: 720px;">
            <div class="hint mono" id="mqttCaCurrentStatus"></div>
            <div class="form-row">
              <label>CA File</label>
              <input id="mqttCaFile" type="file" accept=".crt,.pem,.cer,application/x-pem-file" />
            </div>
            <div class="form-row">
              <label></label>
              <div class="row-actions">
                <button class="btn" id="mqttCaDownloadBtn" type="button">Download current</button>
                <button class="btn primary" id="mqttCaUploadBtn" type="button">Upload</button>
              </div>
            </div>
            <div class="hint mono" id="mqttCaStatus"></div>
          </div>
        </div>
      </div>
    </section>

    <section id="tab-users" class="panel">
      <h2>Users</h2>
      <div class="hint">Manage users and roles in opcbridge (stored in <code>passwords.jsonc</code>). Requires admin role for changes.</div>

      <div class="card">
        <div class="card-title">Users & Roles (opcbridge)</div>
        <div class="card-body">
          <div class="hint mono" id="usersStatusLine">Loading…</div>

          <div id="usersInitWrap" style="display:none; margin-top: 10px;">
            <div class="divider"></div>
            <div class="hint">First-time setup (creates the initial admin user).</div>
            <div class="form" style="max-width: 520px;">
              <div class="form-row"><label>Username</label><input id="usersInitUsername" type="text" autocomplete="username" /></div>
              <div class="form-row"><label>Admin Password</label><input id="usersInitPassword" type="password" autocomplete="new-password" /></div>
              <div class="form-row"><label>Confirm Password</label><input id="usersInitConfirm" type="password" autocomplete="new-password" /></div>
              <div class="form-row"><label>Session Timeout (min)</label><input id="usersInitTimeout" type="number" min="0" step="1" placeholder="0" /></div>
              <div class="form-row"><label></label>
                <div class="row-actions">
                  <button class="btn primary" id="usersInitBtn" type="button">Initialize</button>
                </div>
              </div>
              <div class="hint mono" id="usersInitStatus"></div>
            </div>
          </div>

          <div id="usersManageWrap" style="display:none; margin-top: 10px;">
            <div class="divider"></div>
            <div class="form" style="max-width: 520px;">
              <div class="form-row"><label>Session Timeout (min)</label><input id="usersTimeoutMinutes" type="number" min="0" step="1" placeholder="0" /></div>
              <div class="form-row"><label></label>
                <div class="row-actions">
                  <button class="btn" id="usersRefreshBtn" type="button">Refresh</button>
                  <button class="btn primary" id="usersTimeoutSaveBtn" type="button">Save Timeout</button>
                </div>
              </div>
              <div class="hint mono" id="usersTimeoutStatus"></div>
            </div>

            <div class="divider"></div>

            <div class="users-workspace" style="min-height: 560px;">
              <div class="sidebar">
                <div class="sidebar-title">Directory</div>
                <div class="tree-body" id="usersTreeView"></div>
                <div class="tree-note mono" id="usersTreeNote"></div>
              </div>

              <section class="editor users-right">
                <div class="card">
                  <div class="card-title">Details</div>
                  <div class="card-body">
                    <div class="hint mono" id="usersDetailsStatus"></div>

                    <section id="usersDetailsTablePanel">
                      <div class="table-wrap">
                        <table class="table" id="usersDetailsTable">
                          <thead id="usersDetailsThead"></thead>
                          <tbody id="usersDetailsTbody"></tbody>
                        </table>
                      </div>
                    </section>

                    <section id="usersDetailsFormPanel" style="display:none;">
                      <div class="form" style="max-width: 720px;">
                        <div class="form-row"><label id="usersFormIdLabel">ID</label><input id="usersFormId" type="text" /></div>
                        <div class="form-row"><label>Name</label><input id="usersFormLabel" type="text" /></div>
	                        <div class="form-row"><label>Description</label><input id="usersFormDescription" type="text" /></div>
	                        <div class="form-row" id="usersFormPermsRow"><label>Permissions</label><div id="usersFormPerms" class="perm-grid"></div></div>
	                        <div class="form-row" id="usersFormRoleRow" style="display:none;"><label>Role</label><select id="usersFormRole"></select></div>
	                        <div class="form-row" id="usersFormPasswordRow" style="display:none;"><label>New Password</label><input id="usersFormPassword" type="password" autocomplete="new-password" /></div>
	                        <div class="form-row" id="usersFormConfirmRow" style="display:none;"><label>Confirm</label><input id="usersFormConfirm" type="password" autocomplete="new-password" /></div>
                        <div class="form-row"><label></label>
                          <div class="row-actions">
                            <button class="btn" id="usersFormCancelBtn" type="button">Cancel</button>
                            <button class="btn primary" id="usersFormSaveBtn" type="button">Save</button>
                          </div>
                        </div>
                        <div class="hint mono" id="usersFormStatus"></div>
                      </div>
                    </section>
                  </div>
                </div>
              </section>
            </div>
          </div>
        </div>
      </div>
    </section>
	    <section id="tab-workspace" class="panel">
	      <h2>Workspace</h2>
	      <div class="hint">Tree view (Connectivity → Devices → Tags).</div>

      <div class="row-actions" style="margin: 10px 0;">
        <button class="btn primary" id="workspaceSaveBtn" type="button" disabled>Save</button>
        <button class="btn" id="workspaceSaveReloadBtn" type="button" disabled>Save + Reload</button>
        <button class="btn" id="workspaceDiscardBtn" type="button" disabled>Discard</button>
        <div class="hint mono" id="workspaceSaveStatus" style="margin-left: auto;"></div>
      </div>

      <div class="workspace" style="min-height: 560px;">
        <aside class="sidebar tree">
          <div class="sidebar-title">Project</div>
          <div class="tree-body" id="treeView"></div>
          <div class="sidebar-note" id="treeNote"></div>
        </aside>

        <section class="editor workspace-right">
          <div class="editor-body">
            <section id="workspaceDetailsPanel">
              <div class="table-wrap">
                <table class="table" id="workspaceChildrenTable">
                  <thead><tr><th>Name</th></tr></thead>
                  <tbody id="workspaceChildrenTbody"></tbody>
                </table>
              </div>
            </section>
          </div>
        </section>

        <section class="editor workspace-bottom">
          <div class="editor-toolbar">
            <div class="editor-title">Live Tags</div>
            <div class="hint mono" id="workspaceLiveTagsFilter"></div>
            <div class="hint">Read-only from opcbridge <code>/tags</code>.</div>
          </div>
          <div class="editor-body">
            <div class="table-wrap">
              <table class="table" id="workspaceLiveTagsTable">
                <thead><tr><th>Connection</th><th>Tag</th><th>Datatype</th><th>Status</th><th>Value</th><th>Writable</th><th>Timestamp</th></tr></thead>
                <tbody id="workspaceLiveTagsTbody"></tbody>
              </table>
            </div>
          </div>
        </section>
	      </div>
		    </section>

		    <section id="tab-logger" class="panel">
		      <h2>Data Logger</h2>
		      <div class="hint">Configure opcbridge-reporter connections. Settings are stored on the SCADA server.</div>

		      <div class="workspace" style="min-height: 560px;">
		        <aside class="sidebar tree">
		          <div class="sidebar-title">Data Logger</div>
		          <div class="tree-body" id="loggerTreeView"></div>
		          <div class="sidebar-note" id="loggerTreeNote"></div>
		        </aside>

		        <section class="editor workspace-right">
		          <div class="editor-body">
		            <div class="row-actions" style="margin: 0 0 10px 0;">
		              <button class="btn" id="loggerRefreshBtn" type="button">Refresh</button>
		              <div class="hint mono" id="loggerStatus" style="margin-left: auto;"></div>
		            </div>

		            <div class="table-wrap">
		              <table class="table" id="loggerDbTable">
		                <thead>
		                  <tr>
		                    <th>ID</th>
		                    <th>Name</th>
		                    <th>Type</th>
		                    <th>MySQL Host</th>
		                    <th>Port</th>
		                    <th>User</th>
		                    <th>Database</th>
		                    <th>opcbridge</th>
		                    <th>Password</th>
		                  </tr>
		                </thead>
		                <tbody id="loggerDbTbody"></tbody>
		              </table>
		              <table class="table" id="loggerReportsTable" style="display:none;">
		                <thead>
		                  <tr>
		                    <th>ID</th>
		                    <th>Name</th>
		                    <th>Database</th>
		                    <th>Mode</th>
		                    <th>Schedule</th>
		                    <th>Enabled</th>
		                  </tr>
		                </thead>
		                <tbody id="loggerReportsTbody"></tbody>
		              </table>
		            </div>

		            <details class="details" style="margin-top: 10px;">
		              <summary class="small">Raw JSON</summary>
		              <pre class="mono" id="loggerJson">Loading…</pre>
		            </details>
		          </div>
		        </section>
		      </div>
		    </section>

		    <section id="tab-logs" class="panel">
		      <h2>Logs</h2>
		      <div class="hint">Requires <code>suite.view_logs</code>.</div>

	      <div class="card">
	        <div class="card-title">Logs</div>
	        <div class="card-body">
	          <div class="form" style="max-width: 720px;">
	            <div class="form-row">
	              <label>Source</label>
	              <select id="logsSource"></select>
	            </div>
	            <div class="form-row">
	              <label>Service</label>
	              <select id="logsUnit"></select>
	            </div>
	            <div class="form-row">
	              <label>Lines / Limit</label>
	              <input id="logsLines" type="number" min="10" max="5000" step="10" value="400" />
	            </div>
	            <div class="form-row">
	              <label></label>
	              <div class="row-actions">
	                <button class="btn primary" id="logsRefreshBtn" type="button">Refresh</button>
	              </div>
	            </div>
	            <div class="hint mono" id="logsStatus"></div>
	          </div>

	          <div class="divider"></div>
	          <pre class="mono" id="logsOutput" style="max-height: 520px; overflow:auto; white-space: pre; margin:0;">Select a service and click Refresh.</pre>
	        </div>
	      </div>
	    </section>
	  </main>


  
  <div class="modal-overlay" id="workspaceItemModal" style="display:none;">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="workspaceItemModalTitle">
      <div class="modal-titlebar">
        <div class="modal-title" id="workspaceItemModalTitle">Properties</div>
        <button class="btn" id="workspaceItemCloseBtn" type="button">Close</button>
      </div>
      <div class="modal-body">
        <div class="hint" id="workspaceItemHint"></div>

        <section id="workspaceItemDeviceEdit" style="display:none;">
          <div class="form" style="max-width: 720px;">
            <div class="form-row"><label>Device ID</label><input id="editDevId" type="text" /></div>
            <div class="form-row"><label>Driver</label><select id="editDevDriver">
              <option value="ab_eip">Allen-Bradley Ethernet/IP</option>
            </select></div>
            <div class="form-row"><label>Gateway</label><input id="editDevGateway" type="text" placeholder="192.0.2.10" /></div>
            <div class="form-row"><label>Path</label><input id="editDevPath" type="text" placeholder="1,0" /></div>
            <div class="form-row"><label>Slot</label><input id="editDevSlot" type="number" step="1" min="0" placeholder="0" /></div>
            <div class="form-row"><label>PLC Type</label><select id="editDevPlcType">
              <option value="lgx">Allen-Bradley Logix (ControlLogix / CompactLogix)</option>
              <option value="mlgx">Allen-Bradley MicroLogix</option>
              <option value="micro800">Allen-Bradley Micro800 (Micro8xx)</option>
              <option value="slc">Allen-Bradley SLC 500</option>
              <option value="plc5">Allen-Bradley PLC-5</option>
              <option value="lgx-pccc">Logix (PCCC gateway mode)</option>
              <option value="omron-njnx">OMRON NJ/NX</option>
            </select></div>
            <div class="form-row"><label></label>
              <div class="row-actions">
                <button class="btn" id="editDevCancelBtn" type="button">Cancel</button>
                <button class="btn primary" id="editDevSaveBtn" type="button">Save</button>
              </div>
            </div>
            <div class="hint mono" id="editDevStatus"></div>
          </div>
        </section>

        <section id="workspaceItemTagEdit" style="display:none;">
          <div class="form" style="max-width: 720px;">
            <div class="form-row"><label>Connection</label><input id="editTagConn" type="text" disabled /></div>
            <div class="form-row"><label>Tag Name</label><input id="editTagName" type="text" disabled /></div>
            <div class="form-row"><label>PLC Tag</label><input id="editTagPlc" type="text" placeholder="Pump1.Running" /></div>
            <div class="form-row"><label>Datatype</label><select id="editTagDatatype"></select></div>
            <div class="form-row"><label>Scan (ms)</label><input id="editTagScan" type="number" min="0" step="1" placeholder="1000" /></div>
            <div class="form-row">
              <label>Options</label>
              <div class="check-row">
                <label class="check-pill"><input id="editTagEnabled" type="checkbox" class="inline-check" /> Enabled</label>
                <label class="check-pill"><input id="editTagWritable" type="checkbox" class="inline-check" /> Writable</label>
                <label class="check-pill"><input id="editTagMqttAllowed" type="checkbox" class="inline-check" /> MQTT command allowed</label>
              </div>
            </div>
            <div class="form-row">
              <label>Scaling</label>
              <select id="editTagScaling">
                <option value="none">None</option>
                <option value="linear">Linear</option>
              </select>
            </div>
            <div class="form-row" id="editTagScalingLinearRow" style="display:none;">
              <label>Linear</label>
              <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div><div class="hint">Raw Low</div><input id="editTagRawLow" type="number" step="any" /></div>
                <div><div class="hint">Raw High</div><input id="editTagRawHigh" type="number" step="any" /></div>
                <div><div class="hint">Scaled Low</div><input id="editTagScaledLow" type="number" step="any" /></div>
                <div><div class="hint">Scaled High</div><input id="editTagScaledHigh" type="number" step="any" /></div>
                <div><div class="hint">Scaled Datatype</div><select id="editTagScaledDatatype"></select></div>
                <div style="display:flex; align-items:center; gap: 12px; flex-wrap: wrap;">
                  <label class="check-pill"><input id="editTagClampLow" type="checkbox" class="inline-check" /> Clamp Low</label>
                  <label class="check-pill"><input id="editTagClampHigh" type="checkbox" class="inline-check" /> Clamp High</label>
                </div>
              </div>
            </div>
            <div class="form-row"><label></label>
              <div class="row-actions">
                <button class="btn" id="editTagCancelBtn" type="button">Cancel</button>
                <button class="btn primary" id="editTagSaveBtn" type="button">Save</button>
              </div>
            </div>
            <div class="hint mono" id="editTagStatus"></div>
          </div>
        </section>

        <section id="workspaceItemAlarmEdit" style="display:none;">
          <div class="form" style="max-width: 860px;">
            <div class="form-row"><label>Alarm ID</label><input id="editAlarmId" type="text" placeholder="High_WetwellLevel" /></div>
            <div class="form-row"><label>Name</label><input id="editAlarmName" type="text" placeholder="Wetwell High Level" /></div>
            <div class="form-row"><label>Group</label><input id="editAlarmGroup" type="text" placeholder="Plant" /></div>
            <div class="form-row"><label>Site</label><input id="editAlarmSite" type="text" placeholder="Building 30" /></div>
            <div class="form-row"><label>Connection</label><select id="editAlarmConn"></select></div>
            <div class="form-row"><label>Tag</label><select id="editAlarmTag"></select></div>
            <div class="form-row"><label>Type</label><select id="editAlarmType">
              <option value="high">High</option>
              <option value="low">Low</option>
              <option value="change">Change</option>
              <option value="equals">Equals</option>
              <option value="not_equals">Not-equals</option>
            </select></div>
            <div class="form-row">
              <label>Options</label>
              <div class="check-row">
                <label class="check-pill"><input id="editAlarmEnabled" type="checkbox" class="inline-check" /> Enabled</label>
              </div>
            </div>
            <div class="form-row"><label>Severity (0-1000)</label><input id="editAlarmSeverity" type="number" min="0" max="1000" step="1" placeholder="500" /></div>
            <div class="form-row"><label>Threshold</label><input id="editAlarmThreshold" type="number" step="any" placeholder="1000" /></div>
            <div class="form-row"><label>Hysteresis</label><input id="editAlarmHysteresis" type="number" step="any" placeholder="0" /></div>
            <div class="form-row"><label>Message on active</label><input id="editAlarmMsgOn" type="text" /></div>
            <div class="form-row"><label>Message on return</label><input id="editAlarmMsgOff" type="text" /></div>
            <div class="form-row"><label></label>
              <div class="row-actions">
                <button class="btn" id="editAlarmCancelBtn" type="button">Cancel</button>
                <button class="btn primary" id="editAlarmSaveBtn" type="button">Save</button>
              </div>
            </div>
            <div class="hint mono" id="editAlarmStatus"></div>
          </div>
        </section>

        <section id="workspaceItemGeneric" style="display:none;">
          <div class="table-wrap" style="margin-top: 10px;">
            <table class="table" id="workspaceItemTable">
              <thead><tr><th>Field</th><th>Value</th></tr></thead>
              <tbody id="workspaceItemTbody"></tbody>
            </table>
          </div>
        </section>

        <div class="hint mono" id="workspaceItemStatus"></div>
      </div>
    </div>
  </div>

<div class="modal-overlay" id="workspaceNewDevicePanel" style="display:none;">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="newDeviceModalTitle">
      <div class="modal-titlebar">
        <div class="modal-title" id="newDeviceModalTitle">New Device</div>
        <button class="btn" id="newDevModalCloseBtn" type="button">Close</button>
      </div>
      <div class="modal-body">
        <div class="hint" id="newDeviceHint"></div>
        <div class="form" style="max-width: 720px;">
          <div class="form-row"><label>Device ID</label><input id="newDevId" type="text" placeholder="test01" /></div>
          <div class="form-row"><label>Driver</label><select id="newDevDriver">
            <option value="ab_eip">Allen-Bradley Ethernet/IP</option>
          </select></div>
          <div class="form-row"><label>Gateway</label><input id="newDevGateway" type="text" placeholder="192.0.2.10" /></div>
          <div class="form-row"><label>Path</label><input id="newDevPath" type="text" placeholder="1,0" /></div>
          <div class="form-row"><label>Slot</label><input id="newDevSlot" type="number" step="1" min="0" placeholder="0" /></div>
          <div class="form-row"><label>PLC Type</label><select id="newDevPlcType">
            <option value="lgx">Allen-Bradley Logix (ControlLogix / CompactLogix)</option>
            <option value="mlgx">Allen-Bradley MicroLogix</option>
            <option value="micro800">Allen-Bradley Micro800 (Micro8xx)</option>
            <option value="slc">Allen-Bradley SLC 500</option>
            <option value="plc5">Allen-Bradley PLC-5</option>
            <option value="lgx-pccc">Logix (PCCC gateway mode)</option>
            <option value="omron-njnx">OMRON NJ/NX</option>
          </select></div>
          <div class="form-row"><label></label>
            <div class="row-actions">
              <button class="btn" id="newDevCancelBtn" type="button">Cancel</button>
              <button class="btn primary" id="newDevCreateBtn" type="button">Create</button>
            </div>
          </div>
          <div class="hint mono" id="newDevStatus"></div>
        </div>
      </div>
    </div>
  </div>


  <div class="modal-overlay" id="newTagModal" style="display:none;">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="newTagModalTitle">
      <div class="modal-titlebar">
        <div class="modal-title" id="newTagModalTitle">New Tag</div>
        <button class="btn" id="newTagCloseBtn" type="button">Close</button>
      </div>
      <div class="modal-body">
        <div class="hint" id="newTagHint"></div>
        <div class="form" style="max-width: 720px;">
          <div class="form-row"><label>Tag Name</label><input id="newTagName" type="text" placeholder="Pump1.Running" /></div>
          <div class="form-row"><label>PLC Tag</label><input id="newTagPlc" type="text" placeholder="Pump1.Running" /></div>
          <div class="form-row"><label>Datatype</label><select id="newTagDatatype"></select></div>
          <div class="form-row"><label>Scan (ms)</label><input id="newTagScan" type="number" min="0" step="1" placeholder="1000" /></div>
          <div class="form-row">
            <label>Options</label>
            <div class="check-row">
              <label class="check-pill"><input id="newTagEnabled" type="checkbox" class="inline-check" checked /> Enabled</label>
              <label class="check-pill"><input id="newTagWritable" type="checkbox" class="inline-check" /> Writable</label>
              <label class="check-pill"><input id="newTagMqttAllowed" type="checkbox" class="inline-check" /> MQTT command allowed</label>
            </div>
          </div>
          <div class="form-row">
            <label>Scaling</label>
            <select id="newTagScaling">
              <option value="none">None</option>
              <option value="linear">Linear</option>
            </select>
          </div>
          <div class="form-row" id="newTagScalingLinearRow" style="display:none;">
            <label>Linear</label>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
              <div><div class="hint">Raw Low</div><input id="newTagRawLow" type="number" step="any" /></div>
              <div><div class="hint">Raw High</div><input id="newTagRawHigh" type="number" step="any" /></div>
              <div><div class="hint">Scaled Low</div><input id="newTagScaledLow" type="number" step="any" /></div>
              <div><div class="hint">Scaled High</div><input id="newTagScaledHigh" type="number" step="any" /></div>
              <div><div class="hint">Scaled Datatype</div><select id="newTagScaledDatatype"></select></div>
              <div style="display:flex; align-items:center; gap: 12px; flex-wrap: wrap;">
                <label class="check-pill"><input id="newTagClampLow" type="checkbox" class="inline-check" /> Clamp Low</label>
                <label class="check-pill"><input id="newTagClampHigh" type="checkbox" class="inline-check" /> Clamp High</label>
              </div>
            </div>
          </div>
          <div class="form-row"><label></label>
            <div class="row-actions">
              <button class="btn" id="newTagCancelBtn" type="button">Cancel</button>
              <button class="btn primary" id="newTagCreateBtn" type="button">Create</button>
            </div>
          </div>
          <div class="hint mono" id="newTagStatus"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="loginModal" style="display:none;">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="loginModalTitle">
      <div class="modal-titlebar">
        <div class="modal-title" id="loginModalTitle">opcbridge Login</div>
        <button class="btn" id="loginCloseBtn" type="button">Close</button>
      </div>
      <div class="modal-body">
        <div class="hint">Cookie-based SSO across SCADA/HMI works when all apps are opened via the same hostname.</div>
        <div class="form" style="max-width: 520px;">
          <div class="form-row"><label>Username</label><input id="loginUsername" type="text" autocomplete="username" /></div>
          <div class="form-row"><label>Password</label><input id="loginPassword" type="password" autocomplete="current-password" /></div>
          <div class="form-row"><label></label>
            <div class="row-actions">
              <button class="btn" id="loginCancelBtn" type="button">Cancel</button>
              <button class="btn primary" id="loginOkBtn" type="button">Login</button>
            </div>
          </div>
          <div class="hint mono" id="loginStatus"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="loggerDbModal" style="display:none;">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="loggerDbModalTitle">
      <div class="modal-titlebar">
        <div class="modal-title" id="loggerDbModalTitle">Database</div>
        <button class="btn" id="loggerDbCloseBtn" type="button">Close</button>
      </div>
      <div class="modal-body">
        <div class="hint" id="loggerDbHint">Configure a database connection for the data logger.</div>
        <div class="form" style="max-width: 720px;">
          <div class="form-row"><label>ID</label><input id="loggerDbModalId" type="text" placeholder="e.g. plant_mysql" /></div>
          <div class="form-row"><label>Name</label><input id="loggerDbModalName" type="text" placeholder="e.g. Plant Historian" /></div>
          <div class="form-row"><label>Type</label>
            <select id="loggerDbModalType">
              <option value="mysql">MySQL / MariaDB</option>
              <option value="odbc">SQL Server (ODBC)</option>
            </select>
          </div>

          <div class="divider"></div>

          <div class="form-row"><label>opcbridge Base URL</label><input id="loggerDbModalOpcbridgeBaseUrl" type="text" placeholder="http://127.0.0.1:8080" /></div>

          <div class="divider"></div>

          <div id="loggerDbMysqlFields">
            <div class="form-row"><label>MySQL Host</label><input id="loggerDbModalMysqlHost" type="text" placeholder="127.0.0.1" /></div>
            <div class="form-row"><label>MySQL Port</label><input id="loggerDbModalMysqlPort" type="number" min="1" max="65535" step="1" /></div>
            <div class="form-row"><label>MySQL User</label><input id="loggerDbModalMysqlUser" type="text" placeholder="opcbridge" /></div>
            <div class="form-row">
              <label>MySQL Password</label>
              <input id="loggerDbModalMysqlPassword" type="password" placeholder="(unchanged)" />
              <div class="small" id="loggerDbModalMysqlPasswordHint"></div>
            </div>
            <div class="form-row"><label>MySQL Database</label><input id="loggerDbModalMysqlDatabase" type="text" placeholder="opcbridge" /></div>
          </div>

          <div id="loggerDbOdbcFields" style="display:none;">
            <div class="form-row"><label>ODBC Driver</label><input id="loggerDbModalOdbcDriver" type="text" placeholder="e.g. FreeTDS or ODBC Driver 18 for SQL Server" /></div>
            <div class="form-row"><label>SQL Server Host</label><input id="loggerDbModalOdbcHost" type="text" placeholder="127.0.0.1" /></div>
            <div class="form-row"><label>SQL Server Port</label><input id="loggerDbModalOdbcPort" type="number" min="1" max="65535" step="1" placeholder="1433" /></div>
            <div class="form-row"><label>Database</label><input id="loggerDbModalOdbcDatabase" type="text" placeholder="opcbridge" /></div>
            <div class="form-row"><label>User</label><input id="loggerDbModalOdbcUser" type="text" placeholder="opcbridge" /></div>
            <div class="form-row">
              <label>Password</label>
              <input id="loggerDbModalOdbcPassword" type="password" placeholder="(unchanged)" />
              <div class="small" id="loggerDbModalOdbcPasswordHint"></div>
            </div>
            <div class="form-row">
              <label>Options</label>
              <div class="check-row">
                <label class="check-pill"><input id="loggerDbModalOdbcEncrypt" type="checkbox" class="inline-check" checked /> Encrypt</label>
                <label class="check-pill"><input id="loggerDbModalOdbcTrustCert" type="checkbox" class="inline-check" /> Trust server certificate</label>
              </div>
            </div>
            <div class="small">Note: SQL Server support requires ODBC deps installed on the server.</div>
          </div>

          <div class="form-row"><label></label>
            <div class="row-actions">
              <button class="btn" id="loggerDbCancelBtn" type="button">Cancel</button>
              <button class="btn primary" id="loggerDbSaveBtn" type="button">Save</button>
            </div>
          </div>
          <div class="hint mono" id="loggerDbModalStatus"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="loggerReportModal" style="display:none;">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="loggerReportModalTitle">
      <div class="modal-titlebar">
        <div class="modal-title" id="loggerReportModalTitle">Report</div>
        <button class="btn" id="loggerReportCloseBtn" type="button">Close</button>
      </div>
      <div class="modal-body">
        <div class="hint" id="loggerReportHint">Configure a report schedule and tag selection.</div>
        <div class="form" style="max-width: 720px;">
          <div class="form-row"><label>ID</label><input id="loggerReportId" type="text" placeholder="e.g. hist_5m" /></div>
          <div class="form-row"><label>Name</label><input id="loggerReportName" type="text" placeholder="e.g. 5-minute Historian" /></div>
          <div class="form-row"><label>Database</label><select id="loggerReportDatabase"></select></div>
          <div class="form-row"><label>Table</label><input id="loggerReportTable" type="text" placeholder="tag_log" /></div>
          <div class="form-row"><label>Mode</label><select id="loggerReportMode">
            <option value="scheduled">Scheduled</option>
            <option value="event">Event (not yet supported)</option>
          </select></div>

          <div class="form-row">
            <label>Enabled</label>
            <div class="check-row">
              <label class="check-pill"><input id="loggerReportEnabled" type="checkbox" class="inline-check" /> Enabled</label>
              <label class="check-pill"><input id="loggerReportPersistent" type="checkbox" class="inline-check" checked /> Persistent (run after downtime)</label>
            </div>
          </div>

          <div class="divider"></div>

          <div class="form-row">
            <label>Schedule</label>
            <select id="loggerReportScheduleKind">
              <option value="every_n_minutes">Every N minutes (aligned)</option>
              <option value="hourly">Hourly</option>
              <option value="daily">Daily</option>
              <option value="custom">Custom (advanced)</option>
            </select>
          </div>

          <div id="loggerScheduleEveryMinutesWrap">
            <div class="form-row">
              <label>Interval (min)</label>
              <input id="loggerReportEveryMinutes" type="number" min="1" max="1440" step="1" value="5" />
              <div class="small">Runs at minute <code>0, N, 2N, …</code> each hour.</div>
            </div>
          </div>

          <div id="loggerScheduleHourlyWrap" style="display:none;">
            <div class="form-row">
              <label>At</label>
              <div style="display:flex; gap: 10px; align-items:center;">
                <div style="display:flex; gap:6px; align-items:center;">
                  <span class="small mono">min</span>
                  <input id="loggerReportHourlyMinute" type="number" min="0" max="59" step="1" value="0" style="width: 90px;" />
                </div>
                <div style="display:flex; gap:6px; align-items:center;">
                  <span class="small mono">sec</span>
                  <input id="loggerReportHourlySecond" type="number" min="0" max="59" step="1" value="0" style="width: 90px;" />
                </div>
              </div>
              <div class="small">Runs once per hour at the specified minute/second.</div>
            </div>
          </div>

          <div id="loggerScheduleDailyWrap" style="display:none;">
            <div class="form-row">
              <label>At</label>
              <div style="display:flex; gap: 10px; align-items:center;">
                <div style="display:flex; gap:6px; align-items:center;">
                  <span class="small mono">hour</span>
                  <input id="loggerReportDailyHour" type="number" min="0" max="23" step="1" value="23" style="width: 90px;" />
                </div>
                <div style="display:flex; gap:6px; align-items:center;">
                  <span class="small mono">min</span>
                  <input id="loggerReportDailyMinute" type="number" min="0" max="59" step="1" value="55" style="width: 90px;" />
                </div>
                <div style="display:flex; gap:6px; align-items:center;">
                  <span class="small mono">sec</span>
                  <input id="loggerReportDailySecond" type="number" min="0" max="59" step="1" value="0" style="width: 90px;" />
                </div>
              </div>
              <div class="small">Runs once per day (server local time).</div>
            </div>
          </div>

          <details class="details" id="loggerScheduleAdvancedWrap" style="margin-top: 6px; display:none;">
            <summary class="small">Advanced schedule (systemd OnCalendar)</summary>
            <div class="form-row" style="margin-top: 10px;">
              <label>OnCalendar</label>
              <input id="loggerReportOnCalendar" type="text" placeholder="*-*-* *:0/5:00" />
              <div class="small">Examples: every 5 minutes: <code>*-*-* *:0/5:00</code>, daily 23:55: <code>*-*-* 23:55:00</code></div>
            </div>
          </details>

          <div class="small mono" id="loggerReportSchedulePreview" style="margin-top: 6px;"></div>

          <div class="divider"></div>

          <div class="form-row">
            <label>Tags</label>
            <textarea id="loggerReportTags" rows="8" class="mono" placeholder='One per line:\nfield_ops:PLC_Second\nfield_ops:Pump*.Running'></textarea>
            <div class="row-actions" style="margin-top: 8px;">
              <button class="btn" id="loggerReportSelectTagsBtn" type="button">Select Tags…</button>
            </div>
            <div class="small">Case-sensitive. Wildcards supported in tag name (<code>*</code>, <code>?</code>). Format: <code>connection_id:tag_name</code>.</div>
          </div>

          <div class="form-row"><label></label>
            <div class="row-actions">
              <button class="btn" id="loggerReportCancelBtn" type="button">Cancel</button>
              <button class="btn primary" id="loggerReportSaveBtn" type="button">Save + Apply</button>
            </div>
          </div>
          <div class="hint mono" id="loggerReportStatus"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="loggerTagPickerModal" style="display:none;">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="loggerTagPickerTitle" style="max-width: 980px;">
      <div class="modal-titlebar">
        <div class="modal-title" id="loggerTagPickerTitle">Select Tags</div>
        <button class="btn" id="loggerTagPickerCloseBtn" type="button">Close</button>
      </div>
      <div class="modal-body">
        <div class="hint">Choose tags to add to the report. Uses live tag list from opcbridge.</div>
        <div class="form" style="max-width: 960px;">
          <div class="form-row">
            <label>Search</label>
            <input id="loggerTagPickerSearch" type="text" placeholder="filter by connection or tag name" />
          </div>
          <div class="form-row">
            <label></label>
            <div class="row-actions">
              <button class="btn" id="loggerTagPickerSelectAllBtn" type="button">Select All (filtered)</button>
              <button class="btn" id="loggerTagPickerClearBtn" type="button">Clear</button>
              <button class="btn primary" id="loggerTagPickerApplyBtn" type="button">Apply Selection</button>
            </div>
          </div>
          <div class="hint mono" id="loggerTagPickerStatus"></div>
        </div>

        <div class="divider"></div>

        <div class="table-wrap">
          <table class="table" id="loggerTagPickerTable">
            <thead>
              <tr>
                <th style="width: 40px;"></th>
                <th>Connection</th>
                <th>Tag</th>
                <th>Datatype</th>
                <th>Writable</th>
              </tr>
            </thead>
            <tbody id="loggerTagPickerTbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script src="app.js"></script>
</body>
</html>
